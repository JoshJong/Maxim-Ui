/**
 * Created by owenhong on 2016/2/3.
 */
var fs = require("fs");
var path = require('path');
var Imagemin = require('imagemin');
var imageminPngquant = require('imagemin-pngquant');
var Common = require('./common.js');


function imagemin(){}
imagemin.prototype.compressor = function(imgs,config,globalConfig,callback){
    new Imagemin()
        .src(imgs)
        .use(imageminPngquant({quality: '65-85', speed: 4}))
        .use(Imagemin.jpegtran({progressive: true}))
        .use(Imagemin.svgo())
        .use(Imagemin.gifsicle({interlaced: true}))
        .run(function(err,files){
            var imgsLength = imgs.length;
            var index = imgsLength;
            var results = [];

            if(err){
                imgs.forEach(function(result) {
                    //判断文件是否存在，不存在创建文件夹
                    var filePath = result;
                    var $fName = filePath.replace(config.localPath, '').replace(config.destPath, '').replace(/\\/g, '\/');

                    results.push({
                        fName: $fName,
                        status: false,
                        message: "图片压缩失败"
                    });
                });
                return callback(results);
            }

            files.forEach(function(result){
                //判断文件是否存在，不存在创建文件夹
                var filePath = result.path.replace(/\//g, '\\');
                var newName = filePath.replace(config.localPath,config.destPath);
                var f_name = path.basename(newName);
                var destFile = newName.replace(f_name,'');
                Common.createPath(destFile,fs);

                var $fName = filePath.replace(config.localPath, '').replace(config.destPath, '').replace(/\\/g, '\/');

                fs.writeFile(newName, result.contents, function(err) {
                    if(err){
                        results.push({
                            fName: $fName,
                            status: false,
                            message: "图片压缩失败"
                        });

                        index--;
                        if (index <= 0) {
                            callback(results);
                        }
                    }

                    results.push({
                        fName: $fName,
                        status: true,
                        message: "图片压缩成功"
                    });

                    index--;
                    if (index <= 0) {
                        callback(results);
                    }
                });
            });
        });
}

module.exports = imagemin;