/**
 * Created by owenhong on 2016/9/18.
 */

'use strict';

var path	   = require('path'),
    pn		   = require('pn/fs'),
    fse		   = require('fs-extra'),
    svg2png = require("svg2png");

function svgToPng(){}
svgToPng.prototype.init = function(files,config,callback){
    var results = [];
    var index = files.length;
    files.forEach(function(file){

        let relativeFile = file.replace(config.destPath, '').replace(config.localPath, '');
        let svgDest = path.join(config.destPath,relativeFile);

        pn.readFile(file)
            .then(svg2png)
            .then(function(buffer){
                var dirname = (path.dirname(file) + path.sep).replace(config.localPath,config.destPath);
                var basename = path.basename(file,'.svg');
                var svgPngDest = dirname + basename +'.png'

                fse.outputFile(svgPngDest, buffer, function (err) {
                    if(err){
                        results.push({
                            status:false,
                            fName:svgPngDest.replace(config.destPath, '').replace(config.localPath, '').replace(/\\/g, '\/'),
                            message: err.message
                        });

                        index--;
                        if(index <= 0){
                            callback(null,results);
                        }
                        return;
                    }

                    //SVG TO PNG文件输出
                    results.push({
                        status:true,
                        fName:svgPngDest.replace(config.destPath, '').replace(config.localPath, '').replace(/\\/g, '\/'),
                    });

                    fse.readFile(file,function(err,buffer){
                        if(err){
                            //SVG文件输出
                            results.push({
                                status:false,
                                fName:file.replace(config.destPath, '').replace(config.localPath, '').replace(/\\/g, '\/'),
                                message: err.message
                            });

                            index--;
                            if(index <= 0){
                                callback(null,results);
                            }
                            return;
                        }

                        fse.outputFile(svgDest, buffer, function (err) {
                            if(err){
                                //SVG文件输出失败处理
                                results.push({
                                    status:false,
                                    fName:file.replace(config.destPath, '').replace(config.localPath, '').replace(/\\/g, '\/'),
                                    message: err.message
                                });

                                index--;
                                if(index <= 0){
                                    callback(null,results);
                                }

                                return;
                            }

                            //SVG文件输出
                            results.push({
                                status:true,
                                fName:file.replace(config.destPath, '').replace(config.localPath, '').replace(/\\/g, '\/'),
                            });

                            index--;
                            if(index <= 0){
                                callback(null,results);
                            }
                        })
                    })
                });
            })
            .catch(function(error){
                if(error.message.indexOf('Width or height could not be determined from either') >= 0){
                    var errorMessage = new Error(file +': '+ '此SVG文件未设定宽高,无法转换成png');
                }else{
                    var errorMessage = new Error(file +': '+ error.message);
                }

                callback(errorMessage,results);
            });
    })

}

module.exports = svgToPng;